{% extends "base.html" %}

{% block title %}Resultado Â· Eneagrama{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">

    <div class="card shadow-lg border-0 p-4 text-center">

      <h2 class="fw-bold">Tus resultados</h2>

      {% if top_types %}
        {% set principal = top_types[0] %}
        {% set txt = eneatipo_textos[principal] %}
      
        <!-- Recuadro: TÃ­tulo + DescripciÃ³n -->
        <div class="card border-primary mb-3">
          <div class="card-header bg-primary text-white">
            {{ txt.titulo }}
          </div>
          <div class="card-body">
            <p class="card-text">{{ txt.descripcion }}</p>
          </div>
        </div>
      
        <!-- Recuadro: CaracterÃ­sticas principales -->
        <div class="card border-secondary mb-3">
          <div class="card-header bg-secondary text-white">
            ðŸŸ¡ CaracterÃ­sticas principales
          </div>
          <div class="card-body">
            <p class="card-text">{{ txt.caracteristicas }}</p>
          </div>
        </div>
      
        <!-- Recuadro: CÃ³mo puedes sentirte mejor -->
        <div class="card border-success mb-3">
          <div class="card-header bg-success text-white">
            ðŸŸ¡ Â¿CÃ³mo puedes sentirte mejor?
          </div>
          <div class="card-body">
            <p class="card-text">{{ txt.mejorar }}</p>
          </div>
        </div>
      {% endif %}

      {% set porcentaje_total = ((total_marked / 270) * 100) | round(1) %}
      
      <div class="mb-3 text-start">
        <p class="fw-semibold">
          Afirmaciones marcadas: <strong>{{ total_marked }}</strong> de 270
          â€” <strong>{{ porcentaje_total }}%</strong>
        </p>
      
        {% if porcentaje_total > 30 %}
          <p class="text-success">
            ðŸ“£ <strong>No tienes problema en mostrarte.</strong>
          </p>
        {% else %}
          <p class="text-warning">
            ðŸ¤« <strong>Eres mÃ¡s bien reservado, te cuesta mostrarte.</strong>
          </p>
        {% endif %}
      </div>


      <!-- GrÃ¡fico -->
      <canvas id="eneagramaChart"></canvas>
      
      <!-- Chart.js -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <!-- Plugin para mostrar labels (%) -->
      <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
      
      <script>
        // Ejemplo: recibÃ­s desde Flask labels y values ya como porcentajes
        const labels = {{ labels | tojson }};   // ["1","2","3","4","5","6","7","8","9"]
        const values = {{ values | tojson }};   // [33.3, 11.1, 11.1, 0, 11.1, 11.1, 0, 22.2, 0]
      
        const ctx = document.getElementById('eneagramaChart');
      
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: labels.map(x => `Tipo ${x}`),
            datasets: [{
              label: '% de respuestas',
              data: values,
              fill: true,
              borderWidth: 2,
              pointRadius: 3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.raw.toFixed(1)}%`
                }
              },
              datalabels: {
                formatter: (v) => `${v.toFixed(1)}%`,
                anchor: 'end',
                align: 'end'
              }
            },
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: {
                  callback: (v) => `${v}%`
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });
      </script>


      <div class="card mt-4">
        <div class="card-header fw-bold">
          Esencia â€“ Total de afirmaciones
        </div>
        <ul class="list-group list-group-flush text-start">
          {% for tipo, score in sorted_scores %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            Tipo {{ tipo }}
            <span class="badge bg-primary rounded-pill">{{ score }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>

      <div class="card border-warning mt-4 text-start">
        <div class="card-header bg-warning fw-bold">
          Tu camino de evoluciÃ³n
        </div>
        <div class="card-body">
          <p class="mb-3">
            Para librarte de las cadenas invisibles que hoy frenan tu desarrollo es recomendable modificar las siguientes creencias limitantes:
          </p>
      
          <ol class="mb-0">
            {% for tipo, pct, texto in camino_evolucion %}
              <li class="mb-2">
                <strong>Tipo {{ tipo }} ({{ pct }}%)</strong>: {{ texto }}
              </li>
            {% endfor %}
          </ol>
        </div>
      </div>


      <div class="mt-4">
        <a href="{{ url_for('reset') }}" class="btn btn-secondary">
          Volver al inicio
        </a>
      </div>

    </div>

  </div>
</div>
{% endblock %}
